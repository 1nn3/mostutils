#!/usr/bin/env perl

use App::Mostutils;
use App::Mostutils::Threads;
use Fcntl;
use Getopt::Long;
use strict;
use threads;
use Tie::File;

my $keep_query  = undef;
my $max_threads = 8;
my $retrys      = 0;
my $retry_after = 60 * 60;
GetOptions(
    'keep-query'     => \$keep_query,
    'max-threads=i'  => \$max_threads,
    'retrys=i'       => \$retrys,
    'retry-after=i ' => \$retry_after,
) || die $!;

my @fails;
my $file = $ARGV[0];

my @commands;
App::Mostutils::file2list( \@commands, $file, { mode => Fcntl::O_RDWR } )
    or die $file, $!;

sub handler_start {
    my ($command) = @_;
    system($command);
    my $ret = $?;
    return ( $ret, $command );
}

sub handler_stop {
    my ( $ret, $command ) = @_;

    if ( $ret != 0 || $keep_query ) {
        warn "Command returns $ret; keep in query: $command\n";
        push @fails, $command;
    }
}

for (@commands) {
    threads->create( { "context" => "list" }, \&handler_start, ($_) );
    App::Mostutils::loop_threads( \&handler_stop );
}

do {
    App::Mostutils::loop_last_threads( \&handler_stop );
    @commands = @fails;
    @fails    = ();
} while ( $retrys-- && $#commands && sleep($retry_after) );

exit !@fails;

